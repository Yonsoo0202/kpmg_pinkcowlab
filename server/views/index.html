<!DOCTYPE html>
<html>

<head>
   
  
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.js" integrity="sha512-oFOCo2/3DtjrJG4N27BjSLQWoiBv171sK6a+JiWjp/7agxC2nCUP358AqzxkBUb5jX8g6CYLPdSKQTbC0weCwA==" crossorigin="anonymous"></script>
</head>

<body>
    <h1>여기 밑으로 카메라 화면이 출력되어야 한다.</h1>
    <video id="vid" aytoplay></video>

    <h1>여기 밑으로는 결과화면 출력</h1>
    <img src = "">



</body>
<script>
    //streamer
    var constraints = {
        audio: false,
        video: { width: 400, height: 250 },
      };
      var video = document.querySelector("video");
      
      console.log(navigator);
      console.log(navigator.mediaDevices);
      
      //make mediaDevices to empty instance if necessary
      if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
      }
      
      if (navigator.mediaDevices.getUserMedia === undefined) {
        navigator.mediaDevices.getUserMedia = function ( 
          contraints
        ) {
          //use legacy -> getUserMedia -> deprecated
          var getUserMedia =
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia;
      
          //worst case
          if (!getUserMedia) {
            return Promise.reject(
              new Error(
                "getUserMedia is not implemented in this browser"
              )
            );
          }
          return new Promise(function (resolve, reject) {
            getUserMedia.call(
              navigator,
              constraints,
              resolve,
              reject
            );
          });
        };
      }
      
      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(function (mediaStream) {
          
          video.srcObject = mediaStream;
          //아래 코드 없으면 비디오 화면이 재생 안됨
          video.onloadedmetadata = function (e) {
            video.play();
          };
        })
        .catch(function (err) {
          console.log(err.name + ": " + err.message);
        });
      
      
        const getFrame = () => {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video, 0, 0);
          const data = canvas.toDataURL('image/png');
          return data;
      }

      const WS_URL_SEND = location.origin
      const FPS = 3;

      const ws_send = io(WS_URL_SEND);
    
      console.log(`Connected to ${WS_URL_SEND} : client`);
          setInterval(() => {
              ws_send.emit("data", getFrame());
          }, 1);
      
      //client
      
      const img = document.querySelector('img');
              
              ws_send.on("src", (data) => {
                  // set the base64 string to the src tag of the image
                  img.src = data;
                console.log("got")
              });
</script>


</html>